# 工作流名称
name: Auto Release on Tag Push

# 触发条件：当推送到GitHub的标签以v开头（如v1.0.0）时触发
on:
  push:
    tags:
      - 'v*' # 匹配所有以v开头的标签，如v1.0.0、v2.1.3-beta

# 工作流任务
jobs:
  build-and-release:
    runs-on: ubuntu-latest # 运行环境
    permissions:
      id-token: write # Trusted Publisher 核心权限：向npm证明身份
      contents: write # 用于创建GitHub Release
    steps:
      # 步骤1：拉取代码到运行环境
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取所有历史，用于生成发布说明

      # 步骤2：先安装pnpm（关键：提前安装，让setup-node的cache生效）
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: ./package.json # 自动解析pnpm版本
          run_install: false # 暂时不安装项目依赖

      # 步骤3：再设置Node.js环境（此时pnpm已存在，cache可正常执行）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 25 # 建议用20（LTS版本），避免24的兼容性问题
          registry-url: https://registry.npmjs.org/ # 指定npm仓库地址
          cache: 'pnpm' # 现在pnpm已安装，缓存逻辑可正常执行

      # 步骤4：安装项目依赖
      - name: Install dependencies
        run: pnpm install --frozen-lockfile # 锁定依赖版本，保证一致性

      # 步骤5：自动生成发布说明
      - name: Generate release notes
        id: release_notes
        run: |
          # 获取当前标签
          TAG_NAME=${GITHUB_REF#refs/tags/}
          # 获取该标签与上一个标签之间的提交记录，作为发布说明
          RELEASE_NOTES=$(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 $TAG_NAME^)..$TAG_NAME)
          # 输出到环境变量，供后续步骤使用
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

      # 步骤6：创建GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ env.TAG_NAME }}
          body: ${{ env.RELEASE_NOTES }}
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 步骤7：发布到npm（Trusted Publisher模式）
      - name: Publish to npm
        run: |
          # 显式指定registry，避免镜像干扰
          npm publish --provenance --no-git-checks --registry=https://registry.npmjs.org/
        env:
          # 清空token，确保Trusted Publisher生效
          NODE_AUTH_TOKEN: ""
