# 工作流名称
name: Auto Release on Tag Push

# 触发条件：当推送到GitHub的标签以v开头（如v1.0.0）时触发
on:
  push:
    tags:
      - 'v*' # 匹配所有以v开头的标签，如v1.0.0、v2.1.3-beta

# 工作流任务
jobs:
  build-and-release:
    runs-on: ubuntu-latest # 运行环境
    permissions:
      # 必须添加以下权限，Trusted Publisher 需要 GitHub 身份验证
      id-token: write # 用于向 npm 证明身份（核心权限）
      contents: write # 用于创建 GitHub Release
    steps:
      # 步骤1：拉取代码到运行环境
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取所有历史，用于生成发布说明

      # 步骤2：设置Node.js环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24 # 根据你的项目需求选择Node版本
          registry-url: https://registry.npmjs.org/ # 指定npm仓库地址
          # 关键：启用 provenance 所需的身份验证
          cache: 'pnpm' # 缓存pnpm依赖，加速构建

      # 步骤3：安装pnpm（自动读取package.json版本）
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: ./package.json # 自动解析pnpm版本
          run_install: false # 手动安装依赖

      # 步骤4：安装项目依赖
      - name: Install dependencies
        run: pnpm install --frozen-lockfile # 锁定依赖版本

      # 步骤5：自动生成发布说明
      - name: Generate release notes
        id: release_notes
        run: |
          # 获取当前标签
          TAG_NAME=${GITHUB_REF#refs/tags/}
          # 获取该标签与上一个标签之间的提交记录，作为发布说明
          RELEASE_NOTES=$(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 $TAG_NAME^)..$TAG_NAME)
          # 输出到环境变量，供后续步骤使用
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

      # 步骤6：创建GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ env.TAG_NAME }}
          body: ${{ env.RELEASE_NOTES }}
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 步骤7：发布到npm（修复身份验证问题）
      - name: Publish to npm
        run: |
          # 显式指定registry，避免配置问题
          pnpm publish --provenance --no-git-checks --registry=https://registry.npmjs.org/
        env:
          # Trusted Publisher 不需要手动设置 NODE_AUTH_TOKEN，删除即可
          # 关键：确保没有手动注入 token，让 id-token 生效
          NODE_AUTH_TOKEN: ""

      # 备选方案：如果pnpm publish仍失败，改用npm publish（确保provenance和权限）
      # - name: Publish to npm (fallback)
      #   run: npm publish --provenance --no-git-checks
      #   env:
      #     NODE_AUTH_TOKEN: ""
